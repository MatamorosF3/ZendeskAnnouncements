<html>

<head>
    <style type="text/css">
    td {
        font-size: 12px;
    }
    
    #updateIssue {
        display: none;
    }
    </style>
</head>

<body>
    <table id="thetable" class="bordered">
        <thead>
            <tr>
                <th data-field="id">Organization</th>
                <th data-field="name">Issue</th>
                <th data-field="price">Solution</th>
                <th data-field="price">Created BY</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <br>
    <br>
    <div class="row">
        <div class="input-field col s6 m6">
            <select id="status" name="status">
                <option value="" disabled selected>Choose your option</option>
                <option value="1">Pending</option>
                <option value="2">Solved</option>
            </select>
            <label>Status</label>
        </div>
        <div class="col s8">
            <button id="updateIssue" class="btn waves-effect waves-light" type="button" name="action" onclick="Update()" style="display:none">Update
                <i class="material-icons right">send</i>
            </button>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/jquery/3.0.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
<script type="text/javascript">

$(function() {


    var email;
    $('#status').material_select();
    getData();
});

function getData() {
    var client = ZAFClient.init();
    var fetchSelf = {
        url: 'http://ec2-54-159-13-160.compute-1.amazonaws.com:9000/issue/' + localStorage.getItem('id'),
        type: 'GET',
        dataType: 'json'
    };

    client.request(fetchSelf).then(function(data) {

        $('#status').val(data[0].DISPLAY);
        $('#status').material_select();
        for (var i in data) {

            var html = '';
            html += '<tr><td>' + data[i].ORGANIZATION + '</td><td>' + data[i].ISSUE + '</td>' + '<td>' + data[i].SOLUTION + '</td>' + '<td>' + data[i].CREATED_BY + '</td></tr>';
            $('#thetable tr').first().after(html);
        }

        checkAccess(data[0].CREATED_BY);

    }, function(error) {
        console.log("error");
        console.log(error);

    });

}

function checkAccess(email) {
    console.log("Email");
    console.log(email);
    var client = ZAFClient.init();
    var fetchSelf = {
        url: '/api/v2/users/me.json',
        type: 'GET',
        dataType: 'json'
    };

    client.request(fetchSelf).then(function(data) {
        if (data.user.email === email) {
            console.log("same person created");
            $('#status').prop("disabled", false);
            $('#status').material_select();
            $('#updateIssue').css('display', 'block');

        } else {

            $('#status').prop("disabled", true);
            $('#status').material_select();
        }
    });
}

function update(id) {


    $.ajax({
        url: 'http://ec2-54-159-13-160.compute-1.amazonaws.com:9000/issue/' + id,
        type: 'PUT',
        data: {
            status: $('#status').val()
        },
        success: function() {

        },
        error: function() {

        }
    });
}
</script>

</html>
